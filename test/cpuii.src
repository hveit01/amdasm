;ADVANCE MICRO DEVICES
;  AM2903 AND AM2904 CPUII SOURCE FILE

        ORG H#100
INP:    ALUOFF & T & OBF & CJP & GOTO INP
        ALUOFF & PUSH
        IN & T & OBF & LOOP & PUT IOIN
        ALUOFF & RTN

OUTP:   OUT & CONT & PUT YREG
        ALUOFF & PUSH
        ALUOFF & F & ACK & LOOP & PUT IOUT
        ALUOFF & PUSH
        ALUOFF & T & ACK & LOOP
        ALUOFF & RTN
        
USM:    LOW R1 & JSR & GOTO INP
        PAR R0,R15 & JSR & GOTO INP
        LQPT R15 & F & GRD & PUSH & COUNT 00E
        UMUL R1,R1,R0 & F & CNT & SDDL & RFCT
        PAR R15,R1 & JSR & GOTO OUTP
        QMOV R15 & JSR & GOTO OUTP
        JP & GOTO USM

SM:     LOW R1 & JSR & GOTO INP
        PAR R0,R15 & JSR & GOTO INP
        LQPT R15 & F & GRD & PUSH & COUNT 00D
        TCM R1,R1,R0 & F & CNT & SDDL & RFCT
        TCMC R1,R1,R0 & SDDL & CONT CZ
        PAR R15,R1 & JSR & GOTO OUTP
        QMOV R15 & JSR & GOTO OUTP
        ALUOFF & JP & GOTO SM
        
DIV:    LOW R10 & JSR & GOTO INP
        PAR R7,R15 & JSR & GOTO INP
        PAR R1,R15 & JSR & GOTO INP
        PAR R4,R15 & CONT
LOOP1:  PAR R3,R7 & CONT
        PAR R2,R1 & T & MIZ & CJP & GOTO ABORT
        SMTC R2,R2 & CONT CZ
        SMTC R3,R3 & T & MIO & CJP CZ & GOTO SCALE1
        ALUOFF & T & MIO & CJP & GOTO SKIP6
        SURL R3,R3 & SUL & CONT
        SURL R2,R2 & SUL & CONT
        ALUOFF & JP & GOTO LOOP2
SCALE1: LQPT R4 & JSR & GOTO SDIVD
        ALUOFF & JP LOOP1
LOOP2:  SSR R15,R3,R2,YBUS & CONT ONE
SKIP6:  LQPT R4 & F & MIC & CJP & GOTO SKIP3
        ALUOFF & JSR & GOTO SDIVD
        SDRL R2,R2 & SDL & CONT
        ALUOFF & JP & GOTO LOOP2
SKIP3:  ALUOFF & F & GRD & LDCT & COUNT 00C
        DLN R1,R1,R7 & T & GRD & RDU & PUSH
        TDIV R1,R1,R7 & F & CNT & RDU & RFCT CZ
        TDC R1,R1,R7 & SUH & CONT CZ
        QMOV R15 & JSR & GOTO OUTP
        PAR R15,R1 & JSR & GOTO OUTP
        ALUOFF & JP & GOTO DIV
SDIVD:  PAR R1,R1 & CONT
        ALUOFF & T & MIS & CJP & GOTO NEG
        PAR R1,R1,ADRQ & SDDL & CONT
        ALUOFF & JP & GOTO RET
NEG:    PAR R1,R1,ADRQ & SDDL & CONT
RET:    QMOV R4 & CONT
        PAR R10,R10 & RTN ONE

SLNORM: JSR & GOTO INP
        LQPT R15 & CONT
        SLN R2,R2,OFF & CONT & SHOLD
        MAZ & T & CJP & GOTO ABORT
        MAC & T & LOW R0 & CJP & GOTO END
        SLN R2,R2 & MAC & T & CJP ONE & GOTO END & SUL
AGAIN:  SLN R2,R2 & MIO & F & CJP ONE & GOTO AGAIN & SUL
        SDQP & SMS & CONT
        SRS R2,R2,R0 & CONT
        QMOV R15 & JSR & GOTO OUTP
        PAR R15,R2 & JSR & GOTO OUTP
END:    JP & GOTO SLNORM

DLNORM: JSR & GOTO INP
        LQPT R15 & JSR & GOTO INP
        DLN R15,R15,R15,OFF & CONT & SHOLD
        MAZ & T & CJP & GOTO ABORT
        LOW R2 & MAC & T & CJP & GOTO END2
        DLN R15,R15,R15 & SDUL & MAO & T & CJP & GOTO JUMP1
LOOP4:  DLN R15,R15,R15 & SDUL & MIO & T & CJP & GOTO JUMP1
        PAR R2,R2 & JP ONE & GOTO LOOP4
JUMP1:  PAR R2,R2 & CONT ONE
        SDRQ R15,R15 & SDMS & JSR & GOTO OUTP
        QMOV R15 & JSR & GOTO OUTP
END2:   JP & GOTO DLNORM

SQRT:   LOW R10 & CONT
        LOW R0 & JSR & GOTO INP
        PAR R1,R15 & CONT
        PAR R2,R0,,DARB & CONST 0005 & CONT
        PAR R3,R0,,DARB & CONST 0003 & CONT
        PAR R4,R0,,DARB & CONST H#BFFF & CONT
        PAR R5,R0,,DARB & CONST 4000 & CONT
        PAR R6,R0,,DARB & CONST 0008 & CONT
        SRS R0,R1,R5 & CONT & SHOLD
CYCLE:  AND R5,R5,R4 & CONT
        SDRL R4,R4 & MAS & CJP & GOTO END3
        SURL R0,R0 & T & MAS & CJP & GOTO POS
        OR R5,R3 & JP & GOTO CNT
POS:    OR R5,R2 & CONT
CNT:    SRS R6,R6,R10 & CONT
        SDRL R2,R2 & T & MIZ & CJP ,SHLD & GOTO END3
        SDRL R3,R3 & T & MAS & CJP & GOTO SUB
        ADD R0,R0,R5 & JP & GOTO CYCLE & SHOLD
SUB:    SRS R0,R0,R5 & JP & GOTO CYCLE & SHOLD
END3:   JP & GOTO SQRT

ABORT:  ALUOFF & JP & GOTO ABORT
        JP & GOTO DIV
        



END